#!/bin/bash

write_key() {
        mkdir -p "${JENKINS_AGENT_HOME}/.ssh"
        echo "$1" > "${JENKINS_AGENT_HOME}/.ssh/authorized_keys"
        chown -Rf jenkins-slave:jenkins "${JENKINS_AGENT_HOME}/.ssh"
        chmod 0700 -R "${JENKINS_AGENT_HOME}/.ssh"
}

if [ $JENKINS_SLAVE_SSH_PUBKEY == ssh-* ]; then
  write_key "${JENKINS_SLAVE_SSH_PUBKEY}"
fi
if [ $# -gt 0 ]; then
  if [ $1 == ssh-* ]; then
    write_key "$1"
    shift 1
  else
    exec "$@"
  fi
fi

mkdir -p /home/jenkins-slave/.ssh

gitblitKey=`ssh-keyscan -p 29418 gitblit`
while [ -z "$gitblitKey" ]
do
	gitblitKey=`ssh-keyscan -p 29418 gitblit`
done
echo $gitblitKey >> /home/jenkins-slave/.ssh/known_hosts

sh /init/setup-sshd
